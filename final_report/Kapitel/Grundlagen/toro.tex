\section{Toro}
\emph{Toro} has a complicated kinematic structure as shown in Figure \ref{fig:toro_kin}. It consists of 3 kinematic chains branching from the common base. The hip acts as the commnon base. The three chains branching from the hip are  upper body, right leg and left leg. The upper body further branches into right hand and left hand. The two arms and legs acts as the end effectors of \emph{Toro}.

\begin{figure}
\begin{center}
\includegraphics[trim= 70mm 10mm 40mm 10mm,clip,scale=0.7]{Bilder/TORO_kinematic.pdf}
\caption{Kinematic chain of \emph{Toro} \underline{Explain the joints symbols}}
\label{fig:toro_kin}
\end{center}
\end{figure}

The generalized coordinates of \emph{Toro} are represneted by a vector of joint angles $q$ and the coordinates of the base of robot $x^b$. Number of joints of a robot is the number of controllable degrees of freedom \cite[Chapter 2]{mur94}. The coordinates of the base $x^b$ are the underactuated degrees of freedom of \emph{Toro}. 

A rigid body in space has six degrees of freedom as shown in Figure \ref{fig:rbody}.
%\begin{figure}
\begin{figure}
\begin{center}
\includegraphics[trim= 30mm 100mm 10mm 120mm,scale=0.75]{Bilder/rbody_dof.pdf}
\caption[Degrees of freedom of a rigid body]{Degrees of freedom of a rigid body \footnotemark[1]}
\label{fig:rbody}
\end{center}
\end{figure}
The translational and rotational degrees of freedom of the rigid body in Figure \ref{fig:rbody} are \emph{x,y,z} and \emph{roll,pitch,yaw}. The rotational degrees of freedom \emph{roll,pitch,yaw} corresponds to rotation of the body around \textbf{X,Y,Z} axes. The base of \emph{Toro} is assumed to be a free rigid body. Since the base has all the six degrees of freedom which corresponds to degrees of freedom of rigid body floating in three dimensional space, it is called floating base. The equation of motion of a single rigid body(floating base) is given by Newton-Euler equation of motion in body coordinates \cite[Chapter 4]{mur94}. 
\footnotetext[1]{Image source:\url{http://www.cncexpo.com/Images/pitchyawroll.jpg}}
\begin{equation}
\label{eq:dyn_rig_bdy}
\begin{bmatrix}
mI_3 & \textbf{0}_3 \\ \textbf{0}_3 &\Im
\end{bmatrix}
\begin{bmatrix}
\dot{v}^b\\ \dot{\omega}^b
\end{bmatrix}
+ \begin{bmatrix}
\omega^b \times mv^b \\ 
\omega^b \times \Im w^b
\end{bmatrix}
= W^b.\\
\end{equation}
In the above equation, \emph{m} is the mass of the rigid body, $\Im$ is the moment of inertia of the rigid body. $I_3$ represents the $3 \times 3$ identity matrix and $ \textbf{0}_3$ represents the  $3 \times 3$ zero matrix. $[\dot{v}^b,\dot{\omega}^b]$ are the translational velocity and angular velocity represented in body coordinate frame. $W^b$ is the body wrench applied to the center of mass of body. The body wrench represents a force/moment pair acting on the body. It is represented by vector in $\Re^6$ as \citep{mur94}
$$ W^b = \begin{bmatrix} F \\ \tau \end{bmatrix}, $$ where $F \in \Re^3$ is the linear component and $\tau \in \Re^3$ is the rotational component of the genaralized force.

To be consistent with the multibody system dynamics formulation in Equation \ref{eq:dyn_mul_bdy} Newton Euler Equation \ref{eq:dyn_rig_bdy} is reformulated as
\begin{equation}
\label{eq:dyn_rig_bdy_sh}
M_x^b \dot V^b + C_x^b V^b+g_x^b = W^b,
\end{equation}
 where $x^b=\begin{bmatrix}p \\ \theta\end{bmatrix} \in \Re^6$ is a vector representing the position and orientation of the rigid body with respect to world coordinate frame or spatial frame. The three dimensional position vector is $p=\begin{bmatrix}p_x \\ p_y \\ p_z \end{bmatrix} \in \Re^3$ and the three dimesional orientation vector is $ \theta= \begin{bmatrix} \theta_{x} \\ \theta_{y} \\ \theta_{z} \end{bmatrix} \in \Re^3$. The orientation of the rigid body is parmeterised by Euler angles [Appendix \ref{eq:rot_full}]. 
 The body velocity $V^b$ is 
 \begin{equation}
\label{eq:body_vel}
V^b =
\begin{bmatrix}
v^b \\ \omega^b
\end{bmatrix}
= \begin{bmatrix}
R^T \dot{p} \\ (R^T \dot{R})^\vee
\end{bmatrix},
\end{equation}
where $\vee$ operator denotes the extraction of 3 dimensional vector from a skew symmetric matrix[Appendix \ref{sec:avel_trfm}]. The rotation matrix $R$ is the matrix dependent on parameterization of Euler angles [Appendix \ref{eq:rot_full}]. The acceleration $\dot{V}^b$ is the acceleration with respect to body frame. $M_x^b$ represents the inertia matrix of the rigid body in body coordinates. $C_x^b$ is the matrix representing the Coriolis and centrifugal forces acting on the system in body coordinates. $g_x^b$ is the vector representing the gravitational forces acting on the body in body coordinates. $W^b$ is the external force applied to the center of mass of the body. \footnote[2]{Inertia, Coriolis and gravity are assumed to be given with respect to the body coordinate frame for the rest of the report}.

The equations of motion of \emph{Toro} in Figure \ref{fig:toro_kin} is composed of equation of motion of the multibody system and equation of motion of single rigid body. The equation of motion of \emph{Toro} is formulated like the equation of motion for a floating base system as given in \cite{ott09}.
\begin{equation} \label{eq:dyn_biped}
\begin{bmatrix}
M_x &M_{xq} \\ M_{qx} &M_q
\end{bmatrix}
\begin{bmatrix}
\ddot{x}^b \\ \ddot{q}
\end{bmatrix}
+
\begin{bmatrix}
C_x &C_{xq} \\ C_{qx} &C_q
\end{bmatrix}
\begin{bmatrix}
\dot{x}^b \\ \dot{q}
\end{bmatrix}
+
\begin{bmatrix}
g_x \\ g_q
\end{bmatrix}
=
\begin{bmatrix}
0 \\ \tau
\end{bmatrix}
+ (J_r^b)^T W_r^b + (J_l^b)^T W_l^b,
\end{equation}
where the terms with subscript $x$ are the parameters of floating  base, the terms with subscript $q$ are the parameters of the multibody system and the terms with subscript $xq, qx$ are the coupling terms that connects the dynamics of the floating base with dynamics of the multibody system.

Equation \ref{eq:dyn_biped} can be written in a simplified form as
\begin{equation} \label{eq:dyn_sbiped}
M(y)\ddot{y} + C(y,\dot{y})\dot{y} + g(y) = \tau + (J_r^b)^T W_r^b + (J_l^b)^T W_l^b,
\end{equation}
where $y = \begin{bmatrix} x^b \\ q \end{bmatrix}$ is the vector representing the state variables of \emph{Toro}. The generalized coordinates of multibody system is $q \in \Re^{25}$ which represents the vector of joint angles. The vector of generalized velocities is $\dot{y}=\begin{bmatrix} V^{b} \\ \dot{q} \end{bmatrix} \in \Re^{31}.$ The vector of generalized accelerations is $\ddot{y}\in \Re^{31}.$  $M(y)\in \Re^{31 \times 31}$ is the inertia matrix, $C(y,\dot{y})\in \Re^{31 \times 31}$ is the matrix accounting for centrifugal and Coriolis forces. $g(y) \in \Re^{31}$ is the gravity vector. $\tau \in \Re^{31}$ is the vector of actuating torques acting on the robot, where the first six components are zero because those degrees of freedom corresponding to $x_f$ are not actuated. $J_r^b,J_l^b \in \Re^{31 \times 6}$ are the body Jacobian matrices that transforms the wrenches $W_r^b,W_l^b \in \Re^{6}$ applied in the right and left foot to generalized forces acting on the robot. From here on the super script $b$ in body Jacobian matrix and body wrenches is omitted for the sake of simplicity.

The forward dynamics equation of \emph{Toro} is
\begin{equation}
	\label{eq:motion}
	\ddot{y} = M(y)^{-1}(-C(y,\dot{y})\dot{y} - g(y) + J_r(y)^{T}W_{r} +J_l(y)^{T}W_{l} + \tau). 
\end{equation}

\subsection{State space representation:}
The state space representation of \emph{Toro} is formulated similar to the state space representation of multibody system in Equation \ref{eq:dyn_ss}. The state space representation of Equation \ref{eq:motion} is
\begin{equation}
\label{eq:newton_motion}
 \begin{bmatrix}
\frac{dy}{dt} \\ \frac{d\dot y}{dt}
\end{bmatrix}
= \begin{bmatrix}
\dot y \\  M(y)^{-1}(-C(y,\dot{y})\dot{y} - g(y) + J_r(y)^{T}W_{r} +J_l(y)^{T}W_{l} + \tau) 
\end{bmatrix}
\end{equation}

where $\dot y = \begin{bmatrix} V^b \\ \dot q \end{bmatrix}$. The body velocity $V^b$ is given in Equation \ref{eq:body_vel}. In order for th system to be integrable the linear part of the body velocity is rearranged as 
\begin{equation}
    \label{eq:transfo_linvel}
    \dot p = R v^b.
\end{equation}
Likewise the angular part of the body velocity can be reformulated as 
\begin{equation}
    \label{eq:transfo_angvel}
    \omega^b = T(\theta)\dot{\theta},
\end{equation}
where $T(\theta)$ is the transformation matrix [Appendix \ref{sec:avel_trfm}]. 

 The state space representation of \emph{Toro} is obtained by substituting Equations \ref{eq:transfo_linvel} and \ref{eq:transfo_angvel} in Equation \ref{eq:newton_motion}.
\begin{equation}
\label{eq:toro}
	\dot{x} = 
	\begin{bmatrix}
	\dot{p} \\ \dot{\theta} \\ \dot{q} \\ \ddot{y}
	\end{bmatrix}
	=
	\begin{bmatrix}
	R v^b\\	
	T(\theta)^{-1} \omega_f^b \\
	\dot{q}\\
	M(y)^{-1}(-C(y,\dot{y})\dot{y} -g(y) +  J_r(y)^{T}W_{r} +J_l(y)^{T}W_{l} + \tau)
	\end{bmatrix}.
	\\
\end{equation}	
\begin{comment}
\begin{itemize}
\item $$ y = \begin{bmatrix} p \\ \theta \\ q \end{bmatrix} = \begin{bmatrix} x_f \\ q \end{bmatrix}, \dot{y} = \begin{bmatrix} V^b \\ \dot{q}\end{bmatrix}, x = \begin{bmatrix}y \\ \dot{y}\end{bmatrix} $$  $x_f,q$ are the parameters of the floating base and joints as described in \ref{eq:motion}. $V^b$ is the body velocity as defined in \ref{eq:body_vel} and $\dot{q}$ is the velocities of the joints of the robot. \emph{x} is the vector of system states.
\item $T(\theta_{f})$ is the matrix that transforms the angular velocity $\omega_{f}^{b}$ to the time derivative of Euler angles $\dot{\theta}_{f}$. i.e $\omega_{f}^{b}=T(\theta_{f}) \dot{\theta}_{f}$. 
\item R is the rotation matrix which describes the rotation of floating base with respect to spatial frame. $ R = R_x(\theta_x) R_y(\theta_y) R_z(\theta_z)$
\end{itemize}
\end{comment}

%\section{Prediction step}
\input{Kapitel/Grundlagen/toro_predict.tex}

%\section{Update step}
\input{Kapitel/Grundlagen/toro_update.tex}

% Experiments 
\input{Kapitel/Grundlagen/toro_exp.tex}
